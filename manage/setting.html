<?php
    $start_d; $stop_d;
    
    $fp = fopen("./../db/settings.ini", 'r');
    if ($fp === false) {
        die("getcsv-load_settingエラー：設定情報がありません");
    }
    
    $buffer = array();
    $i = 0;
    if (flock($fp, LOCK_SH)){
        while (!feof($fp)) {
            $buffer[$i] = fgets($fp);
            $i++;
        }
        flock($fp, LOCK_UN);
        fclose($fp);
        
        preg_match("/\d{4}\W\d{2}\W\d{2}/", $buffer[7], $ans);
        $start_d = $ans[0];
        preg_match("/\d{4}\W\d{2}\W\d{2}/", $buffer[8], $ans);
        $stop_d = $ans[0];
        preg_match("/\d{4}\W\d{2}\W\d{2}/", $buffer[9], $ans);
        $began_d = $ans[0];
        preg_match("/\d{4}\W\d{2}\W\d{2}/", $buffer[10], $ans);
        $finish_d = $ans[0];
    }else{
        fclose($fp);
    }
    
?>
<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./../css/bootstrap.min.css" type="text/css" />
        <link rel="stylesheet" href="./../css/reserv.css" type="text/css" />
        <script type="text/javascript" src="./../js/jquery.min.js"></script>
        <script type="text/javascript" src="./../js/bootstrap.min.js"></script>
        <script type="text/javascript" defer src="./../js/reserv.js"></script>
        <title>シフト予約システム｜管理｜月度シフト予約事前設定</title>
    </head>
    <body>
        <div class="row">
            <!-- 左余白 -->
            <div class="col-md-2"></div>
            <!-- メインコンテンツ -->
            <div class="col-md-8">
                <h1>月度シフト予約事前設定</h1>
                <h3>
                    現在<?php echo $start_d; ?>から<?php echo $stop_d; ?>までのシフト予約を募集しています。<br />
                    この募集は<?php echo $began_d; ?>から開始されて<?php echo $finish_d; ?>に締め切り予定です。<br />
                    新しく予約設定を指定した段階で、現在の予約設定は消去されますのでご注意ください。
                </h3>
                <div class="progress progress-striped active">
<?php
    if (isset($_POST["res_s"], $_POST["res_e"], $_POST["rec_s"], $_POST["rec_e"]) ) {
        $ps_value = 50;
        $date_form_enabled = false;
    } else {
        $ps_value = 20;
        $date_form_enabled = true;
    }
?>
                    <div class="progress-bar progress-bar-info"  role="progressbar" aria-valuenow="<?php echo $ps_value; ?>" aria-valuemin="0" aria-valuemax="100" style="width: <?php echo $ps_value; ?>%">
                        <span class="sr-only"><?php echo $ps_value; ?>% Complete</span>
                    </div>
                </div>
                <!-- 予約設定 -->
                <form method="post" action="">
                    <h4>１．シフト予約として、募集するはじめ・おわりの日付を指定してください。</h4>
                    <div class="row">
                        <label for="reserv">対象予約期間</label>
                        <div class="form-group">
                            <div class="col-md-6">
                                <input type="date" class="form-control" id="reserv" name="res_s" placeholder="西暦年-月-日" required <?php if (! $date_form_enabled) echo "disabled" ?> />
                                <span class="help-block">開始日</span>
                            </div>
                            <div class="col-md-6">
                                <input type="date" class="form-control" id="reserv" name="res_e" placeholder="西暦年-月-日" required <?php if (! $date_form_enabled) echo "disabled" ?> />
                                <span class="help-block">終了日</span>
                            </div>
                        </div>
                    </div>
                    <h4>２．シフト予約を募集する期間を設定してください。</h4>
                    <div class="row">
                        <label for="reserv">予約募集期間</label>
                        <div class="form-group">
                            <div class="col-md-6">
                                <input type="date" class="form-control" id="reserv" name="rec_s" placeholder="西暦年-月-日" required <?php if (! $date_form_enabled) echo "disabled" ?> />
                                <span class="help-block">開始日</span>
                            </div>
                            <div class="col-md-6">
                                <input type="date" class="form-control" id="reserv" name="rec_e" placeholder="西暦年-月-日" required <?php if (! $date_form_enabled) echo "disabled" ?> />
                                <span class="help-block">終了日</span>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-default pull-right"><?php if ($date_form_enabled) { echo "確定"; } else { echo "再設定"; } ?></button>
                </form>
            </div>
            <!-- 右余白 -->
            <div class="col-md-2">　</div>
        </div>
                <!-- ここで一旦PHP処理で上記formをdisabledにする
                     そのあとで、PHPにてカレンダー（シフト予約の）を出力し、休業時間を指定 -->
<?php
    if (isset($_POST["res_s"], $_POST["res_e"], $_POST["rec_s"], $_POST["rec_e"]) ) {
        include_once('./../core/make_grid.php');
        date_default_timezone_set("Asia/Tokyo");
    
        if (strtotime($_POST["res_s"]) > strtotime($_POST["res_e"]) | strtotime($_POST["rec_s"]) > strtotime($_POST["rec_e"]) ) {
            // 日付設定がおかしい
        } else {
?>
        <blockquote>
            <button type="button" class="btn btn-warning btn-lg" data-toggle="button">毎　週</button>
            <small>毎週同じ時間帯に設定する場合はこちらのボタンを押してください。それぞれの週に個別で指定したいときはもう一度押してください。</small>
        </blockquote>
<?php
            make_grid($_POST["res_s"], $_POST["res_e"], false);
?>
        <form method="post" action="./../core/reserv.php" id="set" name="set" onSubmit="return getdata();">
            <input type="hidden" name="type" value="setup" />
            <input type="hidden" name="res_s" value=<?php echo "\"".$_POST["res_s"]."\""; ?> />
            <input type="hidden" name="res_e" value=<?php echo "\"".$_POST["res_e"]."\""; ?> />
            <input type="hidden" name="rec_s" value=<?php echo "\"".$_POST["rec_s"]."\""; ?> />
            <input type="hidden" name="rec_e" value=<?php echo "\"".$_POST["rec_e"]."\""; ?> />
            <div style="text-align: center">
                <button type="submit" id="btn-state" data-loading-text="処理中..." class="btn btn-primary btn-lg">
                    決　定
                </button>
            </div>
        </form>
<?php
        }
    }
?>
    </body>
</html>